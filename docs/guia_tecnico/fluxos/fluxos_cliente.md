---
sidebar_position: 3
title: Fluxos do Cliente
---

# Fluxos do Cliente

Estes fluxos descrevem a jornada do cliente atrav√©s do bot de WhatsApp, desde o primeiro contato at√© o feedback p√≥s-atendimento.

---

## üìë √çndice de Fluxos

### Fluxos Essenciais (MVP)
1. [Identifica√ß√£o/Cadastro de Cliente](#fluxo-1-identifica√ß√£ocadastro-de-cliente) - Reconhecimento e Registro
2. [Visualiza√ß√£o de Informa√ß√µes de Servi√ßo](#fluxo-2-visualiza√ß√£o-de-informa√ß√µes-de-servi√ßo) - Explora√ß√£o do Cat√°logo
3. [Agendamento de M√∫ltiplos Servi√ßos](#fluxo-3-agendamento-de-m√∫ltiplos-servi√ßos) - Composi√ß√£o de Pacotes
4. [Reagendamento em Caso de Indisponibilidade](#fluxo-4-reagendamento-em-caso-de-indisponibilidade) - Sugest√£o Alternativa
5. [Falha na Obten√ß√£o do Lock (conflito de hor√°rio)](#fluxo-5-falha-na-obten√ß√£o-do-lock-conflito-de-hor√°rio) - Resolu√ß√£o de Conflito
6. [Confirma√ß√£o e Lembrete](#fluxo-6-confirma√ß√£o-e-lembrete) - Confirma√ß√£o e Lembretes

### Fluxos Opcionais
7. [Integra√ß√£o com Pagamento (Futuro)](#fluxo-7-integra√ß√£o-com-pagamento-futuro) - Processamento de Pagamento
8. [Tratamento de Erros e Recupera√ß√£o de Conversa](#fluxo-8-tratamento-de-erros-e-recupera√ß√£o-de-conversa) - Recupera√ß√£o Inteligente
9. [Feedback P√≥s-Atendimento](#fluxo-9-feedback-p√≥s-atendimento) - Avalia√ß√£o do Servi√ßo
10. [Consulta e Reutiliza√ß√£o de Agendamentos Passados](#fluxo-10-consulta-e-reutiliza√ß√£o-de-agendamentos-passados) - Hist√≥rico e Reagendamento

---

## Fluxos Essenciais (MVP)

### Fluxo 1 - Identifica√ß√£o/Cadastro de Cliente

> Persona: Cliente
> Canal: WhatsApp
> Frequ√™ncia: Cada novo cliente ou cliente recorrente
> Objetivo: Reconhecimento e registro do cliente

#### T√≠tulo: Reconhecimento e Registro de Cliente

![SEQREGISTROCLIENTE](../../../static/img/img_fluxos/SEQ-RegistroCliente.png)

#### Hist√≥ria de Usu√°rio
Como cliente, quero ser identificado pelo sistema quando inicio uma conversa no WhatsApp, para que n√£o precise fornecer minhas informa√ß√µes repetidamente a cada novo agendamento.

#### Fluxo de uso (Diagrama de Sequ√™ncia)
1. üí¨ Cliente envia mensagem inicial para o n√∫mero do WhatsApp do estabelecimento
2. ‚òÅÔ∏è WhatsApp Provider envia notifica√ß√£o para üì• Webhook Ingest
3. üì• Webhook Ingest valida assinatura HMAC da mensagem para garantir autenticidade
4. ü§ñ Bot Orchestrator extrai n√∫mero de telefone da mensagem recebida
5. ü§ñ Bot Orchestrator consulta üóÑÔ∏è PostgreSQL para verificar se o cliente j√° existe (SELECT * FROM bookings WHERE cliente_telefone = ?)
6. Se cliente N√ÉO existir no sistema:
   a. ü§ñ Bot Orchestrator solicita nome do cliente
   b. üí¨ Cliente responde com seu nome
   c. ü§ñ Bot Orchestrator armazena temporariamente na sess√£o do ‚ö° Redis
7. Se cliente J√Å existir:
   a. ü§ñ Bot Orchestrator recupera nome e hist√≥rico b√°sico
   b. ü§ñ Bot Orchestrator personaliza sauda√ß√£o ("Ol√° [nome], bem-vindo de volta!")
8. ü§ñ Bot Orchestrator cria ou atualiza sess√£o no ‚ö° Redis com identificador do cliente
9. ü§ñ Bot Orchestrator define estado da sess√£o como "IDENTIFIED"
10. ü§ñ Bot Orchestrator prossegue para o pr√≥ximo est√°gio do fluxo (apresenta√ß√£o de servi√ßos)

#### Crit√©rios de Aceita√ß√£o
- Deve identificar corretamente clientes recorrentes pelo n√∫mero de telefone
- Deve solicitar e capturar nome apenas para novos clientes
- Deve garantir persist√™ncia dos dados do cliente de forma segura e em conformidade com LGPD
- Deve estabelecer sess√£o ativa no Redis com TTL de 30 minutos
- Deve tratar n√∫meros de telefone em diferentes formatos (+55, com/sem DDD)

#### Definition of Done
- Implementa√ß√£o do reconhecimento de clientes por n√∫mero de telefone
- Estrat√©gia de persist√™ncia de dados pessoais implementada com criptografia
- Testes de verifica√ß√£o de identidade para novos e antigos clientes
- Valida√ß√£o de formato de n√∫meros de telefone internacionais
- Documenta√ß√£o dos formatos de sess√£o Redis para clientes
- Implementa√ß√£o de logging para auditoria de identifica√ß√µes

---

### Fluxo 2 - Visualiza√ß√£o de Informa√ß√µes de Servi√ßo

> Persona: Cliente
> Canal: WhatsApp
> Frequ√™ncia: Cada agendamento
> Objetivo: Explora√ß√£o do cat√°logo de servi√ßos

#### T√≠tulo: Explora√ß√£o do Cat√°logo de Servi√ßos

![SEQVISUALIZACAOSERVICOS](../../../static/img/img_fluxos/SEQ-VisuzalizacaoServicos.png)

#### Hist√≥ria de Usu√°rio
Como cliente, quero visualizar detalhes dos servi√ßos dispon√≠veis, para que eu possa entender o que cada servi√ßo inclui, quanto tempo dura e quanto custa antes de fazer minha escolha.

#### Fluxo de uso (Diagrama de Sequ√™ncia)
1. ü§ñ Bot Orchestrator verifica estado da sess√£o no ‚ö° Redis (deve ser "IDENTIFIED")
2. ü§ñ Bot Orchestrator solicita ao üåê API Gateway a lista de servi√ßos dispon√≠veis (GET /services?active=true&tenant_id=X)
3. üåê API Gateway consulta üßæ Cat√°logo (com cache ‚ö° Redis priorit√°rio)
4. üßæ Cat√°logo retorna servi√ßos ativos para o tenant
5. ü§ñ Bot Orchestrator formata e apresenta lista resumida de servi√ßos como menu interativo
6. üí¨ Cliente seleciona op√ß√£o "Ver detalhes" para um servi√ßo espec√≠fico
7. ü§ñ Bot Orchestrator solicita detalhes espec√≠ficos do servi√ßo ao üåê API Gateway via ``GET /services/{id}``
8. üåê API Gateway retorna informa√ß√µes detalhadas (descri√ß√£o completa, pre√ßo, dura√ß√£o, imagem se dispon√≠vel)
9. ü§ñ Bot Orchestrator formata e envia detalhes do servi√ßo em mensagem estruturada via ‚òÅÔ∏è WhatsApp Provider
10. ü§ñ Bot Orchestrator apresenta op√ß√µes: "Agendar este servi√ßo", "Ver outro servi√ßo", "Voltar ao menu principal"
11. üí¨ Cliente seleciona op√ß√£o desejada
12. Se "Agendar este servi√ßo", ü§ñ Bot Orchestrator atualiza estado da sess√£o no ‚ö° Redis para "SERVICE_SELECTED" e armazena service_id
13. Fluxo prossegue para sele√ß√£o de data/hora ou retorna para lista de servi√ßos

#### Crit√©rios de Aceita√ß√£o
- Deve exibir lista categorizada de servi√ßos ativos com informa√ß√µes essenciais (nome e pre√ßo)
- Deve permitir visualiza√ß√£o detalhada de cada servi√ßo individualmente
- Deve garantir que informa√ß√µes exibidas (pre√ßo, dura√ß√£o) estejam atualizadas com cache curto
- Deve formata√ß√£o adequada para leitura em dispositivos m√≥veis (mensagens concisas, uso de emojis)
- Deve oferecer navega√ß√£o intuitiva entre lista de servi√ßos e detalhes

#### Definition of Done
- Implementa√ß√£o de templates de mensagens para lista de servi√ßos e detalhes
- Integra√ß√£o com recursos nativos do WhatsApp (bot√µes, listas, cards)
- Caching configurado para informa√ß√µes de cat√°logo (TTL 2-5 minutos)
- Testes de usabilidade em diferentes dispositivos e tamanhos de tela
- Log de an√°lise de quais servi√ßos s√£o mais visualizados
- Mecanismos de feedback implementados para melhorar descri√ß√µes

---

### Fluxo 3 - Agendamento de M√∫ltiplos Servi√ßos

> Persona: Cliente
> Canal: WhatsApp
> Frequ√™ncia: Cada agendamento
> Objetivo: Composi√ß√£o de pacotes de servi√ßos

#### T√≠tulo: Composi√ß√£o de Pacotes de Servi√ßos

![SEQSELECIONARMULTIPLOSSERVICOS](../../../static/img/img_fluxos/SEQ-SelecionarMultiplosServicos.png)

#### Hist√≥ria de Usu√°rio
Como cliente, quero agendar v√°rios servi√ßos para a mesma visita, para que eu possa otimizar meu tempo e realizar m√∫ltiplos procedimentos em sequ√™ncia.

#### Fluxo de uso (Diagrama de Sequ√™ncia)
1. üí¨ Cliente seleciona um servi√ßo inicial da lista
2. ü§ñ Bot Orchestrator atualiza sess√£o no ‚ö° Redis com service_id selecionado
3. ü§ñ Bot Orchestrator pergunta: "Deseja adicionar outro servi√ßo a este agendamento?"
4. Se üí¨ Cliente responde "Sim":
   a. ü§ñ Bot Orchestrator recupera servi√ßos compat√≠veis do üßæ Cat√°logo (considerando servi√ßos j√° selecionados)
   b. ü§ñ Bot Orchestrator apresenta lista filtrada de servi√ßos adicionais
   c. üí¨ Cliente seleciona servi√ßo adicional
   d. ü§ñ Bot Orchestrator adiciona service_id √† lista na sess√£o do ‚ö° Redis
   e. ü§ñ Bot Orchestrator atualiza tempo total e valor estimado do pacote
   f. ü§ñ Bot Orchestrator retorna ao passo 3 (pergunta se deseja adicionar mais)
5. Se üí¨ Cliente responde "N√£o":
   a. ü§ñ Bot Orchestrator apresenta resumo dos servi√ßos selecionados
   b. ü§ñ Bot Orchestrator exibe tempo total e valor total
   c. ü§ñ Bot Orchestrator solicita confirma√ß√£o do pacote
6. üí¨ Cliente confirma sele√ß√£o de servi√ßos
7. ü§ñ Bot Orchestrator atualiza estado da sess√£o no ‚ö° Redis para "SERVICES_CONFIRMED"
8. üìÖ Agenda & Booking calcula dura√ß√£o total dos servi√ßos selecionados
9. üìÖ Agenda & Booking verifica disponibilidade considerando a dura√ß√£o total
10. Fluxo prossegue para sele√ß√£o de data/hora com dura√ß√£o ajustada
11. Nos passos subsequentes, o sistema tratar√° os m√∫ltiplos servi√ßos como um √∫nico bloco de tempo

#### Crit√©rios de Aceita√ß√£o
- Deve permitir sele√ß√£o de at√© 5 servi√ßos em um √∫nico agendamento
- Deve calcular corretamente o tempo total necess√°rio para todos os servi√ßos selecionados
- Deve garantir que apenas combina√ß√µes compat√≠veis de servi√ßos sejam oferecidas
- Deve exibir claramente o resumo do pacote com todos os servi√ßos, tempo total e valor total
- Deve verificar disponibilidade de funcion√°rios habilitados para todos os servi√ßos selecionados

#### Definition of Done
- Implementa√ß√£o de l√≥gica de sele√ß√£o m√∫ltipla na sess√£o do bot
- Algoritmo de c√°lculo de dura√ß√£o total com otimiza√ß√£o de sequ√™ncia
- Regras de compatibilidade de servi√ßos implementadas
- Interface para apresenta√ß√£o de resumo de pacote
- Testes de valida√ß√£o para diferentes combina√ß√µes de servi√ßos
- Persist√™ncia de agendamentos com m√∫ltiplos servi√ßos na base de dados

---

### Fluxo 4 - Reagendamento em Caso de Indisponibilidade

> Persona: Cliente
> Canal: WhatsApp
> Frequ√™ncia: Cada agendamento
> Objetivo: Sugest√£o de hor√°rios alternativos

#### T√≠tulo: Sugest√£o Alternativa de Hor√°rios

![SEQREAGENDARINDISPONIVEL](../../../static/img/img_fluxos/SEQ-ReagendarIndisponivel.png)

#### Hist√≥ria de Usu√°rio
Como cliente, quero receber sugest√µes de hor√°rios alternativos quando minha prefer√™ncia inicial n√£o est√° dispon√≠vel, para que eu possa encontrar um hor√°rio adequado sem reiniciar todo o processo de agendamento.

#### Fluxo de uso (Diagrama de Sequ√™ncia)
1. üí¨ Cliente seleciona data/servi√ßo(s) desejado(s)
2. ü§ñ Bot Orchestrator solicita disponibilidade ao üåê API Gateway (GET /availability?service_id=X&date=Y)
3. üìÖ Agenda & Booking verifica disponibilidade considerando:
   a. Turnos de funcion√°rios habilitados para o(s) servi√ßo(s)
   b. Outros agendamentos existentes
   c. Folgas e bloqueios (tabela time_off)
4. Se n√£o houver hor√°rios dispon√≠veis na data selecionada:
   a. üìÖ Agenda & Booking busca pr√≥ximas 3 datas com disponibilidade
   b. ü§ñ Bot Orchestrator informa: "N√£o temos hor√°rios dispon√≠veis nesta data. Veja outras op√ß√µes:"
   c. ü§ñ Bot Orchestrator apresenta datas alternativas como bot√µes interativos via ‚òÅÔ∏è WhatsApp Provider
5. Se üí¨ Cliente seleciona data alternativa:
   a. üìÖ Agenda & Booking busca hor√°rios dispon√≠veis para nova data
   b. ü§ñ Bot Orchestrator apresenta slots dispon√≠veis
6. Se üí¨ Cliente seleciona "Ver outros profissionais":
   a. üìÖ Agenda & Booking verifica outros funcion√°rios habilitados via üõ†Ô∏è Equipe & Turnos
   b. ü§ñ Bot Orchestrator apresenta op√ß√µes de profissionais e hor√°rios
7. Se üí¨ Cliente seleciona "Ver hor√°rios pr√≥ximos":
   a. üìÖ Agenda & Booking busca disponibilidade para ¬±3 dias da data original
   b. ü§ñ Bot Orchestrator apresenta calend√°rio com disponibilidade indicada
8. üí¨ Cliente seleciona uma das alternativas apresentadas
9. ü§ñ Bot Orchestrator atualiza sess√£o no ‚ö° Redis com nova escolha
10. Fluxo prossegue normalmente para confirma√ß√£o de agendamento

#### Crit√©rios de Aceita√ß√£o
- Deve sugerir automaticamente datas alternativas com disponibilidade
- Deve permitir escolha de outros profissionais habilitados como alternativa
- Deve garantir visualiza√ß√£o de disponibilidade em datas pr√≥ximas (anterior/posterior)
- Deve manter o contexto do servi√ßo selecionado durante todo o processo
- Deve possibilitar a navega√ß√£o entre diferentes alternativas sem perder o progresso

#### Definition of Done
- Algoritmo de sugest√£o inteligente de alternativas implementado
- Interface adaptativa para apresenta√ß√£o de op√ß√µes alternativas
- Cache otimizado para consultas de disponibilidade
- Testes de casos de indisponibilidade e alternativas
- M√©tricas de convers√£o para sugest√µes alternativas
- Documenta√ß√£o de par√¢metros de busca de disponibilidade

---

### Fluxo 5 - Falha na Obten√ß√£o do Lock (conflito de hor√°rio)

> Persona: Cliente
> Canal: WhatsApp
> Frequ√™ncia: Cada agendamento
> Objetivo: Resolu√ß√£o de conflito de reserva

#### T√≠tulo: Resolu√ß√£o de Conflito de Reserva Simult√¢nea

![SEQCONFLITOHORARIO](../../../static/img/img_fluxos/SEQ-ConflitoHorario.png)

#### Hist√≥ria de Usu√°rio
Como cliente, quero ser imediatamente notificado quando o hor√°rio que escolhi acabou de ser reservado por outra pessoa, para que eu possa rapidamente selecionar uma alternativa sem frustra√ß√£o.

#### Fluxo de uso (Diagrama de Sequ√™ncia)
1. üí¨ Cliente seleciona hor√°rio espec√≠fico para agendamento
2. ü§ñ Bot Orchestrator tenta obter lock exclusivo no ‚ö° Redis
   a. Executa comando SETNX ``lock:slot:{staff_id}:{datetime}`` 1 EX 60
3. Se SETNX retorna 0 (lock falhou, outro cliente reservou):
   a. ü§ñ Bot Orchestrator envia mensagem imediata via ‚òÅÔ∏è WhatsApp Provider: "Este hor√°rio acabou de ser reservado por outro cliente"
   b. üìÖ Agenda & Booking busca hor√°rios alternativos pr√≥ximos (¬±30 minutos)
   c. ü§ñ Bot Orchestrator apresenta alternativas mais pr√≥ximas como bot√µes de resposta r√°pida
4. üí¨ Cliente seleciona um dos hor√°rios alternativos
5. ü§ñ Bot Orchestrator tenta obter novo lock para o hor√°rio alternativo no ‚ö° Redis
6. Se novo lock √© bem-sucedido:
   a. Fluxo prossegue normalmente para confirma√ß√£o
7. Se novo lock tamb√©m falha:
   a. ü§ñ Bot Orchestrator informa sobre concorr√™ncia alta
   b. üìÖ Agenda & Booking amplia a janela de busca (¬±60 minutos)
   c. ü§ñ Bot Orchestrator oferece op√ß√µes mais amplas ou data alternativa
8. üí¨ Cliente seleciona nova op√ß√£o ou solicita outra data
9. Sistema registra m√©trica de "colis√£o de hor√°rio" para an√°lise
10. ü§ñ Bot Orchestrator conduz cliente para conclus√£o bem-sucedida do agendamento

#### Crit√©rios de Aceita√ß√£o
- Deve detectar e tratar colis√µes de reserva em tempo real
- Deve sugerir imediatamente alternativas vi√°veis pr√≥ximas ao hor√°rio original
- Deve garantir que o lock seja tempor√°rio (TTL 60 segundos) para evitar deadlocks
- Deve implementar backoff para tentativas repetidas (ampliando janela de alternativas)
- Deve coletar m√©tricas sobre colis√µes para otimiza√ß√£o futura

#### Definition of Done
- Mecanismo de lock distribu√≠do implementado com Redis
- Estrat√©gia de fallback e recupera√ß√£o autom√°tica
- Algoritmo de sugest√£o de alternativas em caso de conflito
- Testes de concorr√™ncia com simula√ß√£o de m√∫ltiplos clientes
- Monitoramento de colis√µes implementado
- Interface de comunica√ß√£o de conflito com tom apropriado

---

### Fluxo 6 - Confirma√ß√£o e Lembrete

> Persona: Cliente
> Canal: WhatsApp
> Frequ√™ncia: Cada agendamento
> Objetivo: Confirma√ß√£o de Agendamento e Lembretes Automatizados

#### T√≠tulo: Confirma√ß√£o de Agendamento e Lembretes Automatizados

![SEQCONFIRMACAOELEMBRETE](../../../static/img/img_fluxos/SEQ-ConfirmacaoNotificacao.png)

#### Hist√≥ria de Usu√°rio
Como cliente, quero receber confirma√ß√£o imediata do meu agendamento e lembretes autom√°ticos antes da data marcada, para que eu n√£o esque√ßa do compromisso e esteja preparado para o servi√ßo.

#### Fluxo de uso (Diagrama de Sequ√™ncia)
1. üìÖ Agenda & Booking cria agendamento com sucesso (POST /bookings)
2. üìÖ Agenda & Booking emite evento booking.confirmed na üì® Fila/EventBus
3. üì£ Notifica√ß√µes consome evento da üì® Fila/EventBus
4. ü§ñ Bot Orchestrator envia mensagem de confirma√ß√£o imediata via ‚òÅÔ∏è WhatsApp Provider com:
   a. Resumo do(s) servi√ßo(s) agendado(s)
   b. Data e hora confirmadas
   c. Nome do profissional
   d. Valor estimado
   e. Instru√ß√µes espec√≠ficas para o servi√ßo (prepara√ß√£o necess√°ria)
   f. Pol√≠tica de cancelamento
   g. Link ou c√≥digo para cancelar/reagendar
5. üì£ Notifica√ß√µes grava registro na tabela notifications no üóÑÔ∏è PostgreSQL
6. ‚è∞ Scheduler agenda lembretes autom√°ticos no ‚ö° Redis:
   a. Lembrete 24h antes (reminder.24h)
   b. Lembrete 2h antes (reminder.2h)
7. No dia anterior, ‚è∞ Scheduler Worker identifica agendamentos para lembrete
8. ‚è∞ Scheduler emite evento reminder.24h para cada agendamento na üì® Fila/EventBus
9. üì£ Notifica√ß√µes consome eventos de lembrete da üì® Fila/EventBus
10. ü§ñ Bot Orchestrator envia lembrete personalizado 24h antes via ‚òÅÔ∏è WhatsApp Provider
11. Sistema repete processo para lembrete de 2h (mais pr√≥ximo ao hor√°rio)
12. Cada notifica√ß√£o enviada √© registrada na tabela notifications com status no üóÑÔ∏è PostgreSQL

#### Crit√©rios de Aceita√ß√£o
- Deve enviar confirma√ß√£o imediata com todos os detalhes relevantes do agendamento
- Deve garantir envio autom√°tico de lembretes 24h e 2h antes do hor√°rio agendado
- Deve incluir instru√ß√µes espec√≠ficas para o servi√ßo (se aplic√°vel)
- Deve fornecer m√©todo claro para cancelamento ou reagendamento
- Deve registrar status de entrega de cada notifica√ß√£o enviada

#### Definition of Done
- Templates de mensagens para confirma√ß√£o e lembretes implementados
- Sistema de scheduling de notifica√ß√µes configurado
- Registro de status de envio/entrega implementado
- Testes de fluxo completo de notifica√ß√µes
- Monitoramento da taxa de entrega de mensagens
- Implementa√ß√£o de QR code/link para acesso r√°pido a op√ß√µes de gerenciamento

---

## Fluxos Opcionais

### Fluxo 7 - Integra√ß√£o com Pagamento (Futuro)

> Persona: Cliente
> Canal: WhatsApp
> Frequ√™ncia: Opcionalmente a cada agendamento
> Objetivo: Processamento de Pagamento e Reserva Antecipada

#### T√≠tulo: Processamento de Pagamento e Reserva Antecipada

![SEQCONFIRMACAOELEMBRETE](../../../static/img/img_fluxos/SEQ-ConfirmacaoNotificacao.png)

#### Hist√≥ria de Usu√°rio
Como cliente, quero ter a op√ß√£o de pagar antecipadamente ou deixar um dep√≥sito de reserva para garantir meu hor√°rio, para que eu agilize meu atendimento no dia e o estabelecimento tenha garantias contra faltas.

#### Fluxo de uso (Diagrama de Sequ√™ncia)
1. Ap√≥s confirma√ß√£o do agendamento, ü§ñ Bot Orchestrator pergunta via ‚òÅÔ∏è WhatsApp Provider: "Deseja garantir sua reserva com pagamento antecipado?"
2. ü§ñ Bot Orchestrator apresenta op√ß√µes:
   a. "Pagar integralmente agora" (100%)
   b. "Pagar sinal de reserva" (30%)
   c. "Pagar no local"
3. üí¨ Cliente seleciona op√ß√£o de pagamento
4. Se op√ß√£o inclui pagamento antecipado:
   a. Finance Service gera link de pagamento via gateway externo (Stripe/MercadoPago)
   b. ü§ñ Bot Orchestrator envia link de pagamento seguro via ‚òÅÔ∏è WhatsApp Provider
   c. üí¨ Cliente √© redirecionado para p√°gina de pagamento
   d. Gateway processa pagamento
   e. Gateway envia webhook para üì• Webhook Ingest
5. Finance Service processa webhook do gateway via üì• Webhook Ingest
6. Finance Service atualiza status financeiro do agendamento no üóÑÔ∏è PostgreSQL
7. Finance Service emite evento payment.processed na üì® Fila/EventBus
8. üì£ Notifica√ß√µes consome evento da üì® Fila/EventBus
9. ü§ñ Bot Orchestrator envia confirma√ß√£o de pagamento recebido via ‚òÅÔ∏è WhatsApp Provider
10. ü§ñ Bot Orchestrator inclui recibo digital/comprovante
11. Finance Service atualiza estado do agendamento para "pre_paid" ou "partially_paid" no üóÑÔ∏è PostgreSQL
12. Evento fica registrado para concilia√ß√£o financeira futura

#### Crit√©rios de Aceita√ß√£o
- Deve oferecer m√∫ltiplas op√ß√µes de pagamento (total, parcial, no local)
- Deve integrar-se seguramente com gateways de pagamento populares
- Deve processar webhooks de confirma√ß√£o em tempo real
- Deve gerar comprovantes e recibos digitais ap√≥s pagamento
- Deve atualizar status financeiro do agendamento de forma at√¥mica

#### Definition of Done
- Integra√ß√£o com gateway de pagamento implementada
- Processamento seguro de webhooks configurado
- Templates de recibos e comprovantes criados
- Testes de fluxo completo de pagamento
- Documenta√ß√£o de concilia√ß√£o financeira
- Monitoramento de transa√ß√µes e alertas de falhas

---

### Fluxo 8 - Tratamento de Exce√ß√µes e Fallback

> Persona: Cliente
> Canal: WhatsApp
> Frequ√™ncia: Conforme necess√°rio
> Objetivo: Recupera√ß√£o Inteligente de Conversa√ß√£o

#### T√≠tulo: Recupera√ß√£o Inteligente de Conversa√ß√£o

![SEQTRATAMENTOERROS](../../../static/img/img_fluxos/SEQ-TratamentoErros.png)

#### Hist√≥ria de Usu√°rio
Como cliente, quero que o bot compreenda minhas inten√ß√µes mesmo quando n√£o sigo o fluxo exato ou uso linguagem natural variada, para que a experi√™ncia seja fluida e eu possa resolver minhas necessidades sem frustra√ß√µes.

#### Fluxo de uso (Diagrama de Sequ√™ncia)
1. üí¨ Cliente envia mensagem que n√£o corresponde √†s op√ß√µes esperadas
2. ü§ñ Bot Orchestrator identifica resposta fora do padr√£o esperado
3. ü§ñ Bot Orchestrator tenta classificar inten√ß√£o usando regras de NLP simples
4. Se inten√ß√£o for reconhecida, mas fora de contexto:
   a. ü§ñ Bot Orchestrator salva estado atual na sess√£o do ‚ö° Redis
   b. ü§ñ Bot Orchestrator atende √† inten√ß√£o reconhecida
   c. ü§ñ Bot Orchestrator oferece retorno ao fluxo anterior
5. Se inten√ß√£o n√£o for reconhecida:
   a. ü§ñ Bot Orchestrator envia mensagem via ‚òÅÔ∏è WhatsApp Provider: "N√£o compreendi. Voc√™ quer dizer..."
   b. ü§ñ Bot Orchestrator oferece 2-3 op√ß√µes mais prov√°veis como bot√µes
6. Ap√≥s 2 tentativas falhas consecutivas:
   a. ü§ñ Bot Orchestrator simplifica as op√ß√µes
   b. ü§ñ Bot Orchestrator oferece menu principal como fallback
7. Ap√≥s 3 tentativas falhas ou timeout (5 minutos sem resposta):
   a. ü§ñ Bot Orchestrator pergunta: "Deseja continuar seu agendamento ou precisa de ajuda?"
   b. ü§ñ Bot Orchestrator oferece op√ß√£o "Falar com atendente" (se dispon√≠vel)
8. Se üí¨ Cliente seleciona "Falar com atendente":
   a. ü§ñ Bot Orchestrator registra solicita√ß√£o em fila de atendimento no ‚ö° Redis
   b. ü§ñ Bot Orchestrator informa tempo estimado de espera
   c. ü§ñ Bot Orchestrator mant√©m conversa em modo assistido
9. ü§ñ Bot Orchestrator registra pontos de abandono no üóÑÔ∏è PostgreSQL para otimiza√ß√£o futura

#### Crit√©rios de Aceita√ß√£o
- Deve reconhecer varia√ß√µes comuns de linguagem natural para comandos principais
- Deve implementar recupera√ß√£o progressiva (3 n√≠veis) antes de oferecer atendimento humano
- Deve manter contexto da conversa mesmo ap√≥s desvios de fluxo
- Deve identificar timeout de intera√ß√£o e oferecer retomada contextual
- Deve coletar m√©tricas de pontos de abandono para melhoria cont√≠nua

#### Definition of Done
- Implementa√ß√£o de regras b√°sicas de NLP para reconhecimento de inten√ß√£o
- Sistema de fallback progressivo implementado
- Mecanismo de detec√ß√£o de timeout configurado
- Interface para transfer√™ncia para atendimento humano
- Testes com varia√ß√µes de linguagem natural
- Dashboard de an√°lise de pontos de abandono

---

### Fluxo 9 - Feedback P√≥s-Intera√ß√£o

> Persona: Cliente
> Canal: WhatsApp
> Frequ√™ncia: Ap√≥s cada agendamento conclu√≠do
> Objetivo: Avalia√ß√£o do Servi√ßo e Melhoria Cont√≠nua

#### T√≠tulo: Avalia√ß√£o da Experi√™ncia de Agendamento

![SEQFEEDBACKCLIENTE](../../../static/img/img_fluxos/SEQ-FeedbackCliente.png)

#### Hist√≥ria de Usu√°rio
Como cliente, quero poder fornecer feedback sobre minha experi√™ncia com o bot de agendamento, para que o servi√ßo possa melhorar continuamente e atender melhor √†s minhas necessidades.

#### Fluxo de uso (Diagrama de Sequ√™ncia)
1. Ap√≥s conclus√£o bem-sucedida do agendamento
2. ü§ñ Bot Orchestrator aguarda 2 minutos (para n√£o interromper imediatamente)
3. ü§ñ Bot Orchestrator envia mensagem via ‚òÅÔ∏è WhatsApp Provider: "Sua reserva est√° confirmada. Como foi sua experi√™ncia de agendamento hoje?"
4. ü§ñ Bot Orchestrator apresenta escala de satisfa√ß√£o (1-5 estrelas) como bot√µes interativos
5. üí¨ Cliente seleciona n√≠vel de satisfa√ß√£o
6. Se avalia√ß√£o ‚â§ 3:
   a. ü§ñ Bot Orchestrator pergunta: "Como podemos melhorar?"
   b. üí¨ Cliente fornece feedback textual
   c. ü§ñ Bot Orchestrator categoriza feedback (usando palavras-chave simples)
   d. ü§ñ Bot Orchestrator registra avalia√ß√£o e feedback na tabela feedback do üóÑÔ∏è PostgreSQL
7. Se avalia√ß√£o ‚â• 4:
   a. ü§ñ Bot Orchestrator agradece e pergunta: "O que voc√™ mais gostou?"
   b. üí¨ Cliente fornece feedback positivo
   c. ü§ñ Bot Orchestrator registra pontos fortes mencionados no üóÑÔ∏è PostgreSQL
8. ü§ñ Bot Orchestrator finaliza com: "Obrigado pelo feedback. Estamos sempre buscando melhorar."
9. ü§ñ Bot Orchestrator emite evento feedback.collected na üì® Fila/EventBus
10. Analytics Service processa feedback para dashboards
11. Periodicamente, ‚è∞ Scheduler gera relat√≥rios de satisfa√ß√£o por fluxo

#### Crit√©rios de Aceita√ß√£o
- Deve solicitar feedback em momento oportuno, sem prejudicar a experi√™ncia principal
- Deve oferecer m√©todo simples e r√°pido de avalia√ß√£o (1-5 estrelas)
- Deve coletar feedback qualitativo para avalia√ß√µes baixas
- Deve categorizar automaticamente feedbacks por temas
- Deve integrar dados de feedback em dashboards de qualidade

#### Definition of Done
- Interface de avalia√ß√£o intuitiva implementada
- Armazenamento estruturado de feedbacks configurado
- Categoriza√ß√£o b√°sica de feedback implementada
- Relat√≥rios de satisfa√ß√£o do cliente implementados
- Testes de usabilidade do fluxo de feedback
- Documenta√ß√£o de m√©tricas de qualidade e NPS

---

### Fluxo 10 - Hist√≥rico e Agendamentos Anteriores

> Persona: Cliente Recorrente
> Canal: WhatsApp
> Frqu√™ncia: Conforme necess√°rio
> Objetivo: Consulta e Reutiliza√ß√£o de Agendamentos Passados

#### T√≠tulo: Consulta e Reutiliza√ß√£o de Agendamentos Passados

![SEQHISTORICO](../../../static/img/img_fluxos/SEQ-Historico.png)

#### Hist√≥ria de Usu√°rio
Como cliente recorrente, quero visualizar meu hist√≥rico de agendamentos anteriores e poder reagendar facilmente servi√ßos que j√° utilizei, para economizar tempo e manter consist√™ncia nos servi√ßos que recebo.

#### Fluxo de uso (Diagrama de Sequ√™ncia)
1. üí¨ Cliente envia comando "Meus agendamentos" ou similar
2. ü§ñ Bot Orchestrator identifica inten√ß√£o de consulta hist√≥rica
3. ü§ñ Bot Orchestrator solicita ao üåê API Gateway hist√≥rico do cliente (GET /bookings?cliente_telefone=X&limit=5)
4. üåê API Gateway consulta üìÖ Agenda & Booking filtrando por telefone do cliente
5. üìÖ Agenda & Booking retorna √∫ltimos 5 agendamentos (conclu√≠dos e futuros) do üóÑÔ∏è PostgreSQL
6. ü§ñ Bot Orchestrator formata e envia lista com data, servi√ßo e status via ‚òÅÔ∏è WhatsApp Provider
7. ü§ñ Bot Orchestrator oferece op√ß√µes:
   a. "Ver detalhes" de um agendamento espec√≠fico
   b. "Repetir agendamento" de um servi√ßo anterior
   c. "Ver agendamentos futuros"
8. Se üí¨ Cliente seleciona "Repetir agendamento":
   a. ü§ñ Bot Orchestrator recupera detalhes do servi√ßo anterior
   b. ü§ñ Bot Orchestrator pr√©-preenche sele√ß√£o de servi√ßo na sess√£o atual no ‚ö° Redis
   c. ü§ñ Bot Orchestrator pergunta: "Mesmo profissional?" (se aplic√°vel)
   d. Fluxo prossegue para sele√ß√£o de data/hora
9. Se üí¨ Cliente seleciona "Ver agendamentos futuros":
   a. üìÖ Agenda & Booking filtra apenas agendamentos pendentes
   b. ü§ñ Bot Orchestrator exibe lista com op√ß√µes de "Cancelar" ou "Reagendar"
10. üí¨ Cliente pode selecionar a√ß√µes para cada agendamento futuro

#### Crit√©rios de Aceita√ß√£o
- Deve exibir hist√≥rico dos √∫ltimos 5 agendamentos de forma clara e organizada
- Deve permitir visualiza√ß√£o separada de agendamentos conclu√≠dos e futuros
- Deve facilitar reagendamento de servi√ßos anteriores com m√≠nima entrada de dados
- Deve permitir cancelamento ou altera√ß√£o de agendamentos futuros
- Deve garantir que apenas agendamentos do pr√≥prio cliente sejam exibidos

#### Definition of Done
- Implementa√ß√£o de consulta otimizada de hist√≥rico por cliente
- Interface para exibi√ß√£o de hist√≥rico de agendamentos
- Fluxo de "repetir agendamento" implementado
- Funcionalidades de gerenciamento de agendamentos futuros
- Testes de seguran√ßa para acesso apenas a dados pr√≥prios
- M√©tricas de uso de funcionalidades de hist√≥rico

---